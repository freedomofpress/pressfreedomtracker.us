{% extends "base.html" %}
{% load wagtailcore_tags render_as_template common_tags %}

{% block maincontainer %}
<main>
	{% include 'incident/_incident.html' with incident=page only %}
		{% include "common/_section_heading.html" with label="Related Incidents" %}
		<div class="grid-50">
			{% for related_case in page.get_related_incidents %}
				<div class="grid-50__item">
					{% include "incident/_incident.html" with incident=related_case teaser=True only %}
				</div>
			{% endfor %}
		</div>
		<a
			href="{% pageurl page.get_parent %}?categories={{ page.categories.all|comma_separated_pks:'category' }}"
			class="button button--outline button--center">
			More related incidents
		</a>
</main>
{% endblock %}

{% block sidebar %}
<aside>
	<table class='data-table'>
		<tbody>
			<tr class='data-table__row'>
				<th class="data-table__label">
					Date of Incident
				</th>
				<td class="data-table__value"><a href="{% pageurl page.get_parent %}?lower_date={{ page.date|date:'Y-m-d' }}&upper_date={{ page.date|date:'Y-m-d' }}">{{page.date|date:"F j, Y" }}</a></td>
			</tr>

			{% if page.targets.all %}
				<tr class='data-table__row'>
					<th class="data-table__label">
						Targets
					</th>
					<td class="data-table__value">
						{% with page.targets.all as journalists %}
							<ul class="data-table__list">
								{% for journalist in journalists %}
									<li class="data-table__list-item data-table__list-item--inline">
										<a href="{% pageurl page.get_parent %}?targets={{ journalist.id }}">
										{{ journalist.title }}</a></li>
								{% endfor %}
							</ul>
						{% endwith %}
					</td>
				</tr>
			{% endif %}

			{% if page.affiliation %}
				<tr class='data-table__row'>
					<th class="data-table__label">
						Affiliation
					</th>
					<td class="data-table__value">
						<a href="{% pageurl page.get_parent %}?affiliation={{ page.affiliation }}">
							{{ page.affiliation }}
						</a>
					</td>
				</tr>
			{% endif %}

			{% if page.city or page.state %}
				<tr class='data-table__row'>
					<th class="data-table__label">
						Location
					</th>
					<td class="data-table__value">
						<a href="{% pageurl page.get_parent %}?city={{ page.city }}">
							{{ page.city|default:"" }}
						</a>
						<a href="{% pageurl page.get_parent %}?state={{ page.state.pk }}">{{ page.state|default:"" }}</a>
					</td>
				</tr>
			{% endif %}

			{% with page.last_updated as last_updated %}
				{% if last_updated %}
				<tr class='data-table__row'>
					<th class="data-table__label">
						Last Updated
					</th>
					<td class="data-table__value">
						{{ last_updated|date:"F j, Y" }}
					</td>
				</tr>
				{% endif %}
			{% endwith %}

			{% include 'incident/_arrest_rows.html' %}
			{% include 'incident/_equipment_rows.html' %}
			{% include 'incident/_lawsuit_rows.html' %}
			{% include 'incident/_border_stop_rows.html' %}
			{% include 'incident/_physical_assault_rows.html' %}
			{% include 'incident/_leak_prosecution_rows.html' %}
			{% include 'incident/_subpeona_rows.html' %}
			{% include 'incident/_legal_order_rows.html' %}
			{% include 'incident/_prior_restraint_rows.html' %}
			{% include 'incident/_denial_of_access_rows.html' %}

			{% if page.tags.all %}
				<tr class='data-table__row'>
					<th class="data-table__label">
						Tags
					</th>
					<td class="data-table__value">
						<ul class="data-table__list">
							{% for tag in page.tags.all %}
								<li class="data-table__list-item data-table__list-item--inline">
									<a href="{% pageurl page.get_parent %}?tags={{ tag.pk }}">{{ tag.title }}</a></li>
							{% endfor %}
						</ul>
					</td>
				</tr>
			{% endif %}
		</tbody>
	</table>

	{% with main_category=page.get_main_category %}
		<div>
			<h3 class="section-heading">
				How we track
				{% if main_category.plural_name %}
					{{ main_category.plural_name|title }}
				{% else %}
					{{ main_category|title }}
				{% endif %}
			</h3>
			<p>
				{% with method=main_category.methodology|richtext %}
					{% render_as_template method %}
				{% endwith %}
			</p>
		</div>
		<h3 class="section-heading">
			<a href="{% pageurl main_category %}" >
				More
				{% if main_category.plural_name %}
					{{ main_category.plural_name|title }}
				{% else %}
					{{ main_category|title }}
				{% endif %}
				&gt;
			</a>
		</h3>
	{% endwith %}
</aside>
{% endblock %}
