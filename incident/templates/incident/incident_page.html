{% extends "base.html" %}
{% load wagtailcore_tags %}

{% block maincontainer %}
<main class="layout-right-sidebar">

	<div class="layout-right-sidebar__main">
		<article class="incident incident--{{page.get_parent.title|slugify}}">
			<div class="incident__body">
				<h3 class='incident__category-name incident__category-name--{{page.get_parent.title|slugify}}'>
					{{ page.get_parent.title|upper }}
				</h3>
				<h1 class='incident__title'>
					{{ page.title }}
				</h1>
				<h5 class='incident__date'>
					{{ page.date|date:"F j, Y" }}
				</h5>
				<div class="incident__description">
					{% for block in page.body %}
						<section>{% include_block block %}</section>
					{% endfor %}
				</div>
				{% for update in page.updates.all %}
					<div class="incident__update-item">
						<h5 class='incident__date'>
							{{update.date|date:"F j, Y"}} Update
						</h5>
						<div class="incident__description">
							{% for block in update.body %}
								<section>{% include_block block %}</section>
							{% endfor %}
						</div>
					</div>
					<section>
						<h5></h5>
					</section>
				{% endfor %}
			</div>
		</article>
	</div>{# /.layout-right-sidebar__main #}

	<aside class='layout-right-sidebar__sidebar layout-right-sidebar__column'>
	  <table class='incident incident__details'>
		 <tbody>
		  <tr class='incident__details-row'>
			<td class="incident__details-cell incident__details-cell--bold">
			  Date of Incident
			</td>
			<td class="incident__details-cell">{{page.date|date:"F j, Y" }}</td>
		  </tr>
		  {% if page.journalists.all %}
		  <tr class='incident__details-row'>
			<td class="incident__details-cell incident__details-cell--bold">Journalists</td>
			<td class="incident__details-cell">
			{% with page.journalists.all as journalists %}
			  {% for journalistPage in journalists %}
				{% if not forloop.last %}
				  {{journalistPage.title}},
				{% else %}
				  {{journalistPage.title}}
				{% endif %}
			  {% endfor %}
			{% endwith %}
			</td>
		  </tr>
		  {% endif %}
		  <tr class='incident__details-row'>
			<td class="incident__details-cell incident__details-cell--bold">
			  Last Updated
			</td>

			<td class="incident__details-cell" >
			  {% if page.updates.all %}
				{{ page.updates.first.date|date:"F j, Y" }}
			  {% else %}
				{{page.published_date|date:"F j, Y" }}
			  {% endif %}
			</td>
		  </tr>
		  <tr class='incident__details-row'>
			<td class="incident__details-cell incident__details-cell--bold">
			  Related cases
			</td>
			<td class="incident__details-cell">
			  {% for related_case in page.related_incidents.all %}
			  <a href="{{related_case.url}}" class="incident__text-link" >{{related_case.title}}</a>
			  {% endfor %}
			</td>
		  </tr>
		  <tr class='incident__details-row'>
			<td class="incident__details-cell incident__details-cell--bold">
			  Tags
			</td>
			<td class="incident__details-cell">
			  {% for tag in page.tags.all %}
			  <a href="" class="incident__text-link" >{{tag.name}}</a>
			  {% endfor %}
			</td>
		  </tr>
		</tbody>
	  </table>
	  {% with page.get_parent as category %}
		{% if category.title %}
		  <div class='incident'>
			  <h3 class="incident
				   incident__uppercase-title"
			  >
			  How we track {{category.title}}s
			  </h3>
			  <p>{{category.specific.methodology|richtext}}</p>
		  </div>
		  <h3 class="incident
				   incident__uppercase-title"
			  >
			  <a href="{% pageurl category %}" class="incident__text-link" >
				More {{category.title}}s &gt;
			  </a>
		  </h3>
		{% endif %}
	  {% endwith %}
	</aside>

  {% if page.related_incidents.all %}
	  <div class="incident incident__related-group layout-right-sidebar--two-thirds">
		  <h3 class="incident__uppercase-title
					 layout-right-sidebar__line-break"
		  >
			Related Cases
		  </h3>

		  {% for related_case in page.related_incidents.all %}
			  {% if forloop.counter0 < 2 %}
				  <a  href="{% pageurl related_case %}"
					  class="incident incident--white-background
							  incident--border-{{related_case.get_parent.title|slugify}}
							  incident__related-card
							  incident__card-link"
				  >
					  <h3 class="incident__category-name
								 incident--color-{{related_case.get_parent.title|slugify}}"
					  >
						{{related_case.get_parent.title|upper}}
					  </h3>
					  <h2 class='incident__related-incident-title'>{{related_case.title}}</h2>
					  {% for block in related_case.body %}
						{% if block.block_type == 'rich_text' %}
						  <section>{% include_block block|truncatewords:20 %}</section>
						{% endif %}
					  {% endfor %}
				  </a>
			  {% elif forloop.counter0 == 2 %}
					<div class='layout-right-sidebar--two-thirds'
					>
					  <a href='' class='incident__more-related
										incident__card-link'
					  >
						  MORE RELATED CASES
					  </a>
					</div>
			  {% endif %}
		  {% endfor %}
		</div>
  {% endif %}
</main>

{% endblock %}
