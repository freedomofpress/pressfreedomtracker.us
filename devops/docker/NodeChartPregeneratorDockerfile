# sha256 as of 2023-09-08
FROM node:20-alpine@sha256:c843f4a4060246a25f62c80b3d4cf4a6b4c4639cdce421e4f2ee3102257225b4

# Make npm output less verbose
ENV NPM_CONFIG_LOGLEVEL warn

ARG NPM_VER=9.6.7

# Upgrade npm to speicifed version
RUN npm install npm@${NPM_VER} --location=global

RUN apk add --no-cache paxctl python3 make g++
RUN paxctl -cm /usr/local/bin/node

# Install fonts
RUN apk --no-cache add msttcorefonts-installer fontconfig && \
    update-ms-fonts && \
    fc-cache -f

COPY devops/docker/node-chart-pregenerator-start.sh /usr/bin/node-chart-pregenerator-start.sh

ARG USERID
RUN getent passwd "${USERID?USERID must be supplied}" || adduser -D -g "" -u "${USERID}" pft_node

USER ${USERID}
CMD [ "/usr/bin/node-chart-pregenerator-start.sh" ]
