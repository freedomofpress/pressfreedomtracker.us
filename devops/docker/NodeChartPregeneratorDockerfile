# sha256 as of 2023-09-08
FROM node:20.8.0-alpine@sha256:80cc2c520781c1a4681e59df6791d81a432a6cb3da0c385d8d62e9f16acf8e5f

ARG NPM_VER=10.2.0
# Upgrade npm to specified version
RUN npm install npm@${NPM_VER} --location=global

RUN apk add --no-cache paxctl python3 make g++ curl
RUN paxctl -cm /usr/local/bin/node

# Install fonts
RUN apk --no-cache add msttcorefonts-installer fontconfig && \
    update-ms-fonts && \
    fc-cache -f

# Make npm output less verbose
ENV NPM_CONFIG_LOGLEVEL warn
# Ensure npm can correctly set cache information in ~/.npm
ENV HOME /home/node

ARG USERID
RUN getent passwd "${USERID?USERID must be supplied}" || adduser -D -g "" -u "${USERID}" pft_node
COPY chart_pregenerator /opt/chart-pregenerator
COPY ./client /opt/chart-pregenerator/client
RUN chown -R "${USERID}" /opt/chart-pregenerator
WORKDIR /opt/chart-pregenerator
USER ${USERID}

RUN npm install
RUN npm run build

CMD ["npm", "run", "start"]
