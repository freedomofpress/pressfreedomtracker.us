# sha256 as of 2023-09-08
FROM node:20.8.0-alpine@sha256:80cc2c520781c1a4681e59df6791d81a432a6cb3da0c385d8d62e9f16acf8e5f

ARG NPM_VER=10.2.0
# Upgrade npm to specified version
RUN npm install npm@${NPM_VER} --location=global

RUN apk add --no-cache paxctl python3 make g++ curl
RUN paxctl -cm /usr/local/bin/node

# Install fonts
RUN apk --no-cache add msttcorefonts-installer fontconfig && \
    update-ms-fonts && \
    fc-cache -f

# Make npm output less verbose
ENV NPM_CONFIG_LOGLEVEL warn

COPY devops/docker/node-pregenerator-start.sh /usr/bin/node-pregenerator-start.sh
ARG USERID
RUN getent passwd "${USERID?USERID must be supplied}" || adduser -D -g "" -u "${USERID}" pft_node

WORKDIR /app

RUN chown -R "${USERID}" /app
USER ${USERID}

COPY chart_pregenerator/package*.json ./
COPY chart_pregenerator/dev.js ./
COPY chart_pregenerator/jest.config.js ./
COPY chart_pregenerator/babel.config.json ./

RUN npm ci
CMD [ "/usr/bin/node-pregenerator-start.sh" ]
